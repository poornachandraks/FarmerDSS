<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer App - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm" aria-label="Main navigation">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <h1 class="text-xl font-bold text-gray-900">Farmer's Portal</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-gray-700">Welcome, {{ session.username }}</span>
                    <a href="{{ url_for('logout') }}" 
                       class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500"
                       aria-label="Logout">
                        Logout
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="mb-4 p-4 rounded-lg bg-green-50 text-green-700" role="alert">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Dashboard Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Market Trends Card -->
            <div class="lg:col-span-2 bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-medium text-gray-900">Market Trends</h2>
                        <select id="cropSelector" 
                                class="rounded-md border-gray-300 shadow-sm focus:border-green-500 focus:ring-green-500"
                                aria-label="Select crop">
                            {% for crop in unique_crops %}
                                <option value="{{ crop[1] }}">{{ crop[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mt-4">
                        <canvas id="marketChart" aria-label="Market trends chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weather Data Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h2 class="text-lg font-medium text-gray-900">Current Weather</h2>
                    <div class="mt-4 space-y-3">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Region</span>
                            <span class="text-gray-900 font-medium">{{ weather[0] }}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Temperature</span>
                            <span class="text-gray-900 font-medium">{{ weather[1] }}°C</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">Rainfall</span>
                            <span class="text-gray-900 font-medium">{{ weather[2] }}mm</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Crop Information Card -->
            <div class="lg:col-span-2 bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Crop Information</h2>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200" role="table">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Crop</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Soil Type</th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fertilizers</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for crop in crop_data %}
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ crop[0] }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ crop[1] }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ crop[2] }}</td>
                                    <td class="px-6 py-4 text-sm text-gray-500">{{ crop[4] }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Active Subsidies Card -->
            <div class="bg-white overflow-hidden shadow rounded-lg">
                <div class="p-5">
                    <h2 class="text-lg font-medium text-gray-900 mb-4">Active Subsidies</h2>
                    <div class="space-y-4">
                        {% for subsidy in subsidies %}
                        <div class="border-b border-gray-200 pb-4">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-900">{{ subsidy[1] }}</h3>
                                    <p class="text-sm text-gray-500">{{ subsidy[0] }}</p>
                                    <p class="text-xs text-gray-400">{{ subsidy[2] }}</p>
                                </div>
                                <span class="text-green-600 font-medium">₹{{ subsidy[3] }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Process market trends data
        const marketTrendsData = {{ market_trends|tojson }};
        const marketData = {};
        
        // Group data by crop name
        marketTrendsData.forEach(trend => {
            const cropName = trend[1];  // CropName is at index 1
            if (!marketData[cropName]) {
                marketData[cropName] = [];
            }
            marketData[cropName].push({
                month: `${trend[3]}/${trend[4]}`,  // Month/Year
                price: trend[5],  // AveragePrice
                region: trend[2]  // Region
            });
        });

        // Sort data chronologically for each crop
        Object.keys(marketData).forEach(crop => {
            marketData[crop].sort((a, b) => {
                const [aMonth, aYear] = a.month.split('/').map(Number);
                const [bMonth, bYear] = b.month.split('/').map(Number);
                return (aYear - bYear) || (aMonth - bMonth);
            });
        });

        // Initialize market trends chart
        const marketCtx = document.getElementById('marketChart').getContext('2d');
        const firstCrop = document.getElementById('cropSelector').value;
        
        let marketChart = new Chart(marketCtx, {
            type: 'line',
            data: {
                labels: marketData[firstCrop].map(d => d.month),
                datasets: [
                    {
                        label: 'North Region',
                        data: marketData[firstCrop]
                            .filter(d => d.region === 'North')
                            .map(d => d.price),
                        borderColor: 'rgb(34, 197, 94)',
                        tension: 0.1
                    },
                    {
                        label: 'South Region',
                        data: marketData[firstCrop]
                            .filter(d => d.region === 'South')
                            .map(d => d.price),
                        borderColor: 'rgb(59, 130, 246)',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: `Price Trends - ${firstCrop}`
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `₹${context.raw}/quintal`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price (₹/quintal)'
                        }
                    }
                }
            }
        });

        // Update chart on crop selection
        document.getElementById('cropSelector').addEventListener('change', (e) => {
            const selectedCrop = e.target.value;
            
            marketChart.data.labels = marketData[selectedCrop].map(d => d.month);
            marketChart.data.datasets[0].data = marketData[selectedCrop]
                .filter(d => d.region === 'North')
                .map(d => d.price);
            marketChart.data.datasets[1].data = marketData[selectedCrop]
                .filter(d => d.region === 'South')
                .map(d => d.price);
            
            marketChart.options.plugins.title.text = `Price Trends - ${selectedCrop}`;
            marketChart.update();
        });
    </script>
</body>
</html> 